{"version":3,"file":"index.umd.min.js","sources":["../src/utils.js","../src/components/index.js","../src/components/color.js","../src/components/block.color-gradient.js","../src/components/block.color-list.js","../src/components/radius.js","../src/components/image.js","../src/expression.js","../src/index.js"],"sourcesContent":["export const ensureArray = thing => (Array.isArray(thing) ? thing : [thing]);\n\nexport const map = (val, x1, y1, x2 = 0, y2 = 100) => ((val - x1) * (y2 - x2)) / (y1 - x1) + x2;\n\nexport const chunk = (array, size) => Array.from(\n\t{ length: Math.ceil(array.length / size) },\n\t(v, i) => array.slice(i * size, i * size + size),\n);\n\nexport const zip = (array, ...arrays) => (\n\tarray.map((v, i) => arrays.reduce((acc, arr) => [...acc, arr[i]], [v]))\n);\n\nexport const toPair = stop => (stop.length === 2 ? stop : [null, ...stop]);\n\nexport const toBins = stops => {\n\tconst other = stops.find(([input]) => input === null);\n\treturn stops.reduce((acc, [low, out], i) => {\n\t\tif (i === stops.length - 1) acc.push([low, out]);\n\t\telse if (out !== other[1]) acc.push([[low, stops[i + 1][0]], out]);\n\t\treturn acc;\n\t}, []);\n};\n\nexport const createElement = (tag, options = {}) => {\n\tconst { classes, styles, attributes, content, appendTo } = options;\n\tconst el = document.createElement(tag);\n\tif (classes) ensureArray(classes).forEach(c => el.classList.add(c));\n\tif (styles) Object.entries(styles).forEach(prop => el.style.setProperty(...prop));\n\tif (attributes) Object.entries(attributes).forEach(([attr, value]) => { el[attr] = value; });\n\tel.append(...ensureArray(content).filter(child => child !== null && child !== undefined));\n\tif (appendTo) appendTo.appendChild(el);\n\treturn el;\n};\n\nexport const serializeLabel = (value, metadata) => {\n\tconst { labels = {}, unit = '' } = metadata || {};\n\treturn Array.isArray(value)\n\t\t? value[1]\n\t\t\t? value.map(v => labels[v] || `${v}${unit}`).join(' - ')\n\t\t\t: `+${labels[value[0]] || `${value[0]}${unit}`}`\n\t\t: value !== null\n\t\t\t? labels[value] || `${value}${unit}`\n\t\t\t: labels.other || 'other';\n};\n","import color from './color';\nimport radius from './radius';\nimport image from './image';\n\nexport default { color, radius, image };\n","import GradientBar from './block.color-gradient';\nimport BulletList from './block.color-list';\n\nexport default (expression, layer) => {\n\tif (!expression) return null;\n\tswitch (expression.name) {\n\t\tcase 'interpolate':\n\t\t\treturn GradientBar(expression, layer);\n\t\tcase 'match':\n\t\tcase 'step':\n\t\tcase 'literal':\n\t\t\treturn BulletList(expression, layer);\n\t\tdefault:\n\t\t\treturn undefined;\n\t}\n};\n","import { createElement, serializeLabel, map } from '../utils';\n\nexport default (expression, { metadata }) => {\n\tif (!expression) return null;\n\tconst { inputs, stops, min, max } = expression;\n\tconst gradient = stops.map(([value, color]) => `${color} ${map(value, min, max)}%`);\n\treturn createElement('div', {\n\t\tclasses: 'gradient',\n\t\tcontent: [\n\t\t\tcreateElement('p', {\n\t\t\t\tclasses: 'labels',\n\t\t\t\tcontent: inputs.map(input => createElement('span', {\n\t\t\t\t\tstyles: { left: `${map(input, min, max)}%` },\n\t\t\t\t\tcontent: serializeLabel(input, metadata),\n\t\t\t\t})),\n\t\t\t}),\n\t\t\tcreateElement('div', {\n\t\t\t\tclasses: 'bar',\n\t\t\t\tstyles: { 'background-image': `linear-gradient(90deg, ${gradient})` },\n\t\t\t}),\n\t\t],\n\t});\n};\n","import { createElement, serializeLabel } from '../utils';\n\nexport default (expression, { metadata }) => {\n\tif (!expression) return null;\n\treturn createElement('ul', {\n\t\tclasses: ['list', 'list--color'],\n\t\tcontent: expression.stops.map(([value, color]) => createElement('li', {\n\t\t\tstyles: { '--color': color },\n\t\t\tcontent: serializeLabel(value, metadata),\n\t\t})),\n\t});\n};\n","import { createElement, serializeLabel } from '../utils';\n\nexport default (expression, { metadata }) => {\n\tif (!expression) return null;\n\treturn createElement('ul', {\n\t\tclasses: 'bubbles',\n\t\tcontent: expression.stops\n\t\t\t.sort((a, b) => b[1] - a[1]) // order from bigger to smaller\n\t\t\t.map(([value, radius]) => createElement('li', {\n\t\t\t\tstyles: { '--radius': `${radius}px` },\n\t\t\t\tcontent: createElement('span', {\n\t\t\t\t\tcontent: serializeLabel(value, metadata),\n\t\t\t\t}),\n\t\t\t})),\n\t});\n};\n","import { createElement, serializeLabel } from '../utils';\n\nexport default (expression, { metadata }, map) => {\n\tif (!expression) return null;\n\treturn createElement('ul', {\n\t\tclasses: ['list', 'list--icons'],\n\t\tcontent: expression.stops.map(([value, image]) => {\n\t\t\tconst { height, width, data } = map.style.imageManager.images[image].data;\n\t\t\tconst size = Math.max(width, height);\n\t\t\tconst canvas = createElement('canvas', { attributes: { width: size, height: size } });\n\t\t\tconst ctx = canvas.getContext('2d');\n\t\t\tconst offsetX = (size - width) / 2;\n\t\t\tconst offsetY = (size - height) / 2;\n\t\t\tconst imageData = new ImageData(Uint8ClampedArray.from(data), width, height);\n\t\t\tctx.putImageData(imageData, offsetX, offsetY);\n\t\t\treturn createElement('li', {\n\t\t\t\tcontent: [\n\t\t\t\t\tcreateElement('img', {\n\t\t\t\t\t\tclasses: ['icon'],\n\t\t\t\t\t\tattributes: { src: canvas.toDataURL() },\n\t\t\t\t\t}),\n\t\t\t\t\tserializeLabel(value, metadata),\n\t\t\t\t],\n\t\t\t});\n\t\t}),\n\t});\n};\n","import { chunk, zip, toPair, toBins } from './utils';\n\nconst stopper = {\n\tliteral: expression => [[...expression, ...expression]],\n\tinterpolate: expression => chunk(expression.slice(2), 2),\n\tmatch: expression => chunk(expression.slice(1), 2).map(toPair),\n\tstep: expression => toBins([...chunk(expression.slice(2), 2), [null, expression[1]]]),\n};\n\nconst isExpression = exp => Array.isArray(exp) && exp.length && typeof exp[0] === 'string';\n\nconst parse = input => {\n\tconst [name, ...args] = isExpression(input) ? input : ['literal', input];\n\tconst stops = stopper[name](args);\n\tconst [inputs, outputs] = zip(...stops);\n\tconst min = Math.min(...inputs);\n\tconst max = Math.max(...inputs);\n\treturn { name, stops, inputs, outputs, min, max };\n};\n\nexport default { isExpression, parse };\n","import './styles.scss';\nimport components from './components';\nimport Expression from './expression';\nimport { createElement } from './utils';\n\nconst defaults = {\n\tcollapsed: false,\n\ttoggler: false,\n\tlayers: undefined,\n};\n\nexport default class LegendControl {\n\tconstructor(options) {\n\t\tthis._class = 'mapboxgl-ctrl-legend';\n\t\tthis._options = { ...defaults, ...options };\n\t\tthis._loadLayer = this._loadLayer.bind(this);\n\t}\n\n\tonAdd(map) {\n\t\tthis._map = map;\n\t\tthis._container = createElement('div', {\n\t\t\tclasses: ['mapboxgl-ctrl', this._class],\n\t\t});\n\t\tthis._map.on('styledata', this._loadLayer);\n\t\treturn this._container;\n\t}\n\n\tonRemove() {\n\t\tthis._container.parentNode.removeChild(this._container);\n\t\tthis._map.off('styledata', this._loadLayer);\n\t\tthis._map = undefined;\n\t}\n\n\t_loadLayer() {\n\t\tconst { collapsed, toggler, layers } = this._options;\n\t\tthis._map.getStyle().layers\n\t\t\t.filter(({ id }) => !layers || layers.find(layer => id.match(layer)))\n\t\t\t.filter(({ source }) => source && source !== 'composite')\n\t\t\t.reverse()\n\t\t\t.forEach(layer => {\n\t\t\t\tconst { id, layout, paint, metadata } = layer;\n\t\t\t\tconst selector = `${this._class}-pane--${id}`;\n\t\t\t\tconst prevPane = document.querySelector(`.${selector}`);\n\t\t\t\tconst open = prevPane ? prevPane.open : !collapsed;\n\t\t\t\tconst pane = createElement('details', {\n\t\t\t\t\tclasses: [`${this._class}-pane`, selector],\n\t\t\t\t\tattributes: { open },\n\t\t\t\t\tcontent: [\n\t\t\t\t\t\t// Panel header\n\t\t\t\t\t\tcreateElement('summary', {\n\t\t\t\t\t\t\tcontent: [\n\t\t\t\t\t\t\t\t(metadata && metadata.name) || id, // Layer name or identifier\n\t\t\t\t\t\t\t\t...(toggler ? [this._toggleButton(id)] : []), // Toggler button\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t}),\n\t\t\t\t\t\t// Panel content\n\t\t\t\t\t\t...Object.entries({ ...layout, ...paint }).map(([attr, expression]) => {\n\t\t\t\t\t\t\tconst [, property] = attr.split('-');\n\t\t\t\t\t\t\tconst parsedExpression = Expression.parse(expression);\n\t\t\t\t\t\t\tconst component = components[property];\n\t\t\t\t\t\t\treturn component && component(parsedExpression, layer, this._map);\n\t\t\t\t\t\t}),\n\t\t\t\t\t],\n\t\t\t\t});\n\t\t\t\tif (prevPane) this._container.replaceChild(pane, prevPane);\n\t\t\t\telse this._container.appendChild(pane);\n\t\t\t});\n\t}\n\n\t_toggleButton(layer) {\n\t\tconst visibility = this._map.getLayoutProperty(layer, 'visibility') || 'visible';\n\t\treturn createElement('div', {\n\t\t\tclasses: ['toggler', `toggler--${visibility}`],\n\t\t\tattributes: {\n\t\t\t\tonclick: event => {\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tconst visible = visibility === 'none' ? 'visible' : 'none';\n\t\t\t\t\tthis._map.setLayoutProperty(layer, 'visibility', visible);\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n}\n"],"names":["ensureArray","thing","Array","isArray","map","val","x1","y1","x2","y2","chunk","array","size","from","length","Math","ceil","v","i","slice","zip","arrays","reduce","acc","arr","toPair","stop","createElement","tag","options","classes","styles","attributes","content","appendTo","el","document","forEach","c","classList","add","Object","entries","prop","style","setProperty","attr","value","append","filter","child","appendChild","serializeLabel","metadata","labels","unit","join","other","color","expression","layer","name","inputs","stops","min","max","gradient","input","left","GradientBar","BulletList","radius","sort","a","b","image","imageManager","images","data","height","width","canvas","ctx","getContext","offsetX","offsetY","imageData","ImageData","Uint8ClampedArray","putImageData","src","toDataURL","stopper","literal","interpolate","match","step","find","low","out","push","isExpression","exp","args","outputs","defaults","collapsed","toggler","layers","undefined","_class","_options","_loadLayer","this","bind","_map","_container","on","parentNode","removeChild","off","getStyle","id","source","reverse","layout","paint","selector","_this","prevPane","querySelector","open","pane","_toggleButton","property","split","parsedExpression","Expression","component","components","replaceChild","visibility","getLayoutProperty","onclick","event","preventDefault","visible","_this2","setLayoutProperty"],"mappings":"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"}